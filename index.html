<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel protegido</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #app {
            display: none; /* Oculta la app hasta que el usuario esté autenticado */
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login" style="text-align:center; margin-top: 40px;">
        <h2>Ingresar</h2>

        <!-- Botón de Google -->
        <div 
            id="g_id_onload"
            data-client_id="449560223226-s67499o99vrurmdnp87ju5hsabhk743g.apps.googleusercontent.com"
            data-callback="handleCredentialResponse"
            data-auto_prompt="false">
        </div>

        <div 
            class="g_id_signin"
            data-type="standard"
            data-size="large"
            data-theme="outline"
            data-text="sign_in_with"
            data-shape="rectangular"
            data-logo_alignment="left">
        </div>
    </div>

    <!-- APP REAL (OCULTA HASTA LOGIN) -->
    <div id="app">
        <h1>Bienvenido a la app protegida</h1>

        <button onclick="cerrarSesion()">Cerrar sesión</button>

        <h2>Datos protegidos:</h2>
        <pre id="datos"></pre>
    </div>

    <script>
        const APPS_SCRIPT_URL = 
            "https://script.google.com/macros/s/AKfycbx6j4DwX9zpE7zzPhifTMbpuDWcmUtM35agL48qhhb8ABY29y1IWc2ayAxMBMfyTPXH/exec";

        async function handleCredentialResponse(response) {
            const token = response.credential;

            try {
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                const data = await res.json();

                if (!data.success) {
                    alert("❌ Usuario NO autorizado");
                    console.log(data);
                    return;
                }

                // Si está autorizado:
                document.getElementById("login").style.display = "none";
                document.getElementById("app").style.display = "block";

                // Mostrar datos
                document.getElementById("datos").innerText =
                    JSON.stringify(data.data, null, 2);

            } catch (err) {
                console.error(err);
                alert("Error conectando con el servidor");
            }
        }

        function cerrarSesion() {
            google.accounts.id.disableAutoSelect();
            location.reload();
        }
    </script>

</body>
</html>
